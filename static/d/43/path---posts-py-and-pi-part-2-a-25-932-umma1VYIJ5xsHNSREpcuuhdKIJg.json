{"data":{"markdownRemark":{"html":"<p>If you haven't yet, please check out <a href=\"https://websdev.io/posts/a-usb-controller-py-and-pi/\">part one</a> of this little two part blog post for context on this post! :)</p>\n<p>A quick and dirty recap; I've a 3rd party <strong>USB Gamecube controller</strong>, a <strong>Raspberry Pi 3</strong>, and a <strong>large image file</strong> displayed using <strong><a href=\"https://feh.finalrewind.org/\">Feh</a></strong> that I intend to scroll, pan, and zoom around using the controller. How do I accomplish this?</p>\n<h2>Challenges:</h2>\n<ul>\n<li>Read the USB device data in Linux</li>\n<li>Interpret or decode that data</li>\n<li>Map the input data to manipulate the image file in Feh</li>\n<li>Launch the script &#x26; image viewer on Pi startup</li>\n</ul>\n<p>I began by searching for any existing libraries or software that could manage the first two bullet points for me. This lead me to <a href=\"https://jstest-gtk.gitlab.io/\">jstest-gtk</a>, a joystick testing &#x26; configuration tool for Linux. And... it worked! Kind of. It only read <em>some</em> my 3rd party controller's inputs, and aside from that, didn't feature an easy way to remap keys the way I'd have liked to. However, as a complete Linux newbie I was quite thankful that it introduced me to the usb device input interface.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cb9f2e8715da6018c9b62e816b298203/f9626/jstestgtk.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 500px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.81896551724138%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA86AAAPEgHKZHVoAAACV0lEQVQoz42R7U8SARzHD9niQFNfVqtemPbntGrW+gdKh0udc27llm+Y2YM0dK4tZ4IIwoGihIIJOKCT5zueDg4BOTwB2SGPwyZ40L3JtdWLPvvt++K3ffbbvj9gYGxq/J1keHZtQCAempEOf1KPv5kWTL2WScVfFz+vSpaU8hWtRiVe+vL+rUCrgVQKqVq5qttSL8wLgdHJ2bE5/QQUG1kJja5io8oj4fK6Wa+hTsnMcSKXJqhsqkSlYxE/pJCmEngcD0aCSOoIN2xvApBMGkC85VLxZ6162ai3Wi3TnkEplxBRfwS1h1G73+uIhFDngYVZnlHZNEnEcCxDJvW6DcCHIoxA0/RV7ht311VrJpSArGEtjIWDXuLQ54bNCpnkNEMeE4lUMpbLkt82VYBWoz6K4U6nE/G6vR5nGAssLy2qIIXElprewud3MB9iT0bcdotha115cV4sUJkCla2fly3mXeB6R0dXZyfIawe5PC6v/RrI7eru1us2PQHMCLvNP+whry2BuTywcfLVxILoo0g4IxJ+WJgTPn74APgTFovFJJcL6rQaS5DcgGMGVzSO+8kEhrqsTPmox+E6sLodNtRtv3XzBsD67VzJHA6HaZI6iZ/EQ7njQ5KI5tLJIOqEFPJmk66Ui9VqlaYb9/t6/3EZBEHEBbcatdLZaeO8VCtTF7XiCRFVKddK5UqlUi4Ui/X6xb2eHuBv2Gz2s6f9Iy/5/MHn/MEXzAzxB570P1LIZcwvqpVKPp9v0pd9vb3A/9DW1sYkU1jIj+ybdkx72xbz97t3bv8C2JN7rZMAlxUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"jstest-gtk gui screenshot\"\n        title=\"\"\n        src=\"/static/cb9f2e8715da6018c9b62e816b298203/a1a85/jstestgtk.png\"\n        srcset=\"/static/cb9f2e8715da6018c9b62e816b298203/fbcb3/jstestgtk.png 125w,\n/static/cb9f2e8715da6018c9b62e816b298203/dce1f/jstestgtk.png 250w,\n/static/cb9f2e8715da6018c9b62e816b298203/a1a85/jstestgtk.png 500w,\n/static/cb9f2e8715da6018c9b62e816b298203/c0f2f/jstestgtk.png 750w,\n/static/cb9f2e8715da6018c9b62e816b298203/0e034/jstestgtk.png 1000w,\n/static/cb9f2e8715da6018c9b62e816b298203/f9626/jstestgtk.png 1392w\"\n        sizes=\"(max-width: 500px) 100vw, 500px\"\n      />\n  </span>\n  </a></p>\n<blockquote>\n<p>Screenshots of the <a href=\"https://jstest-gtk.gitlab.io/\">jstest-gtk</a> GUI courtesy their website</p>\n</blockquote>\n<p>As luck would have it, investigating the device input interface lead directly to stumbling upon an <a href=\"https://stackoverflow.com/questions/16032982/getting-live-info-from-dev-input\">incredibly useful SO thread</a> breaking down <em>exactly</em> what I was looking for. Below is a piece of code borrowed from a post in that thread that listens for, decodes, and prints the <code class=\"language-text\">/dev/input/js0</code> data coming from a USB controller. I'll walk through what I've learned from it.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">infile_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/dev/input/js0\"</span>\nEVENT_SIZE <span class=\"token operator\">=</span> struct<span class=\"token punctuation\">.</span>calcsize<span class=\"token punctuation\">(</span><span class=\"token string\">\"LhBB\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>infile_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"rb\"</span><span class=\"token punctuation\">)</span>\nevent <span class=\"token operator\">=</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span>EVENT_SIZE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">while</span> event<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>struct<span class=\"token punctuation\">.</span>unpack<span class=\"token punctuation\">(</span><span class=\"token string\">\"LhBB\"</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span>tv_msec<span class=\"token punctuation\">,</span>  value<span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">,</span> number<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> struct<span class=\"token punctuation\">.</span>unpack<span class=\"token punctuation\">(</span><span class=\"token string\">\"LhBB\"</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\n    event <span class=\"token operator\">=</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span>EVENT_SIZE<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The data being streamed from the USB device comes in the form of a <strong>struct</strong>, a C-language data type that holds several related pieces of packaged data. As noted in the post, the joystick event struct represents four pieces of information about the event: </p>\n<ul>\n<li>A timestamp</li>\n<li>The value, represented as a 1 or 0 for button inputs or an integer in between -32767 and 32767 for a joystick's position on an axis</li>\n<li>The type of event, which tells you whether the input is a button or an axis </li>\n<li>\n<p>A number that corresponds to the input that was pressed. </p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-c line-numbers\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> js_event <span class=\"token punctuation\">{</span>\n__u32 time<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* event timestamp in milliseconds */</span>\n__s16 value<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* value */</span>\n__u8 type<span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* event type */</span>\n__u8 number<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* axis/button number */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>The event struct as defined in the Linux kernel source file, <a href=\"https://github.com/torvalds/linux/blob/master/include/uapi/linux/joystick.h\">/linux/joystick.h</a>.</p>\n</blockquote>\n</li>\n</ul>\n<p>Python provides methods to convert structs to usable values, provided a <strong>format string</strong> that represents the expected layout of the data within the struct. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">infile_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/dev/input/js0\"</span>\nEVENT_SIZE <span class=\"token operator\">=</span> struct<span class=\"token punctuation\">.</span>calcsize<span class=\"token punctuation\">(</span><span class=\"token string\">\"LhBB\"</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>The first line declares the path to the USB input device. The second is one of Python's struct methods, passed a format string representing a struct of the following format:</p>","frontmatter":{"date":"February 28, 2019","title":"Py and Pi, part 2","author":"Webs"}}},"pageContext":{}}